<!-- Individual Data Source Card -->
<div class="border border-gray-200 rounded-lg mb-4 bg-white shadow-sm">
    <!-- Data Source Header -->
    <div class="px-4 py-3 bg-gray-50 rounded-t-lg flex items-center justify-between cursor-pointer"
         onclick="toggleDataSource('{{DATA_SOURCE_ID}}')">
        <div class="flex items-center space-x-3">
            <div class="flex-shrink-0">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            <div>
                <h4 class="text-sm font-semibold text-gray-900">{{PBM}} - {{SOURCE_TYPE}}</h4>
                <p class="text-xs text-gray-600">{{FORMULARY_NAME}} â€¢ {{CRITERIA_COUNT}} criteria</p>
            </div>
        </div>
        <div class="flex items-center space-x-2">
            <span class="text-xs text-gray-500">{{CRITERIA_COUNT}} rules</span>
            <svg id="arrow-{{DATA_SOURCE_ID}}" class="w-4 h-4 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </div>
    </div>

    <!-- Expandable Content -->
    <div id="content-{{DATA_SOURCE_ID}}" class="hidden">
        <!-- Criteria List -->
        <div class="px-4 py-3 border-t">
            <h5 class="text-sm font-medium text-gray-700 mb-3">Filtering Criteria</h5>
            <div class="space-y-2">
                {{{CRITERIA_HTML}}}
            </div>

        </div>

    </div>
</div>

<script>
// Toggle data source expansion
function toggleDataSource(dataSourceId) {
    const content = document.getElementById(`content-${dataSourceId}`);
    const arrow = document.getElementById(`arrow-${dataSourceId}`);

    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        arrow.classList.add('rotate-180');
    } else {
        content.classList.add('hidden');
        arrow.classList.remove('rotate-180');
    }
}





// Delete criteria
function deleteCriteria(criteriaId) {
    console.log('Deleting criteria:', criteriaId);

    // Check if this is the last criteria in the model
    const allCriteria = document.querySelectorAll('[data-criteria-id]');
    const isLastCriteria = allCriteria.length === 1;

    let title, message;

    if (isLastCriteria) {
        title = 'Delete Entire Model?';
        message = 'This is the last criteria in the model. Deleting it will remove the entire clinical model. This action cannot be undone.';
    } else {
        title = 'Confirm Deletion';
        message = 'Are you sure you want to delete this criteria? This action cannot be undone.';
    }

    // Use custom confirmation dialog
    ClaimsApp.utils.showConfirmDialog(
        title,
        message,
        () => {
            console.log('User confirmed deletion of criteria:', criteriaId);

            // Send delete request
            fetch(`https://bef4xsajbb.execute-api.us-east-1.amazonaws.com/dev/clinical-models?action=delete-criteria&criteria_id=${criteriaId}&is_last=${isLastCriteria}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show appropriate success notification
                    const successMessage = isLastCriteria
                        ? 'Clinical model deleted successfully!'
                        : 'Criteria deleted successfully!';
                    ClaimsApp.utils.showNotification(successMessage, 'success');

                    if (isLastCriteria) {
                        // Close modal and refresh main table since model is deleted
                        window.closeModal();
                        // Refresh the clinical models table
                        setTimeout(() => {
                            htmx.ajax('GET', 'https://bef4xsajbb.execute-api.us-east-1.amazonaws.com/dev/clinical-models?component=table', {
                                target: '#clinical-models-container',
                                swap: 'innerHTML'
                            });
                        }, 500);
                    } else {
                        // Reload the configure modal to show updated criteria
                        const modelId = document.querySelector('[name="model_id"]')?.value;
                        if (modelId) {
                            setTimeout(() => {
                                htmx.ajax('GET', `https://bef4xsajbb.execute-api.us-east-1.amazonaws.com/dev/clinical-models?component=configure&id=${modelId}`, {
                                    target: '#modal-content',
                                    swap: 'innerHTML'
                                });

                                // Set refresh flag for when modal closes
                                window.clinicalModelNeedsRefresh = true;
                            }, 500);
                        }
                    }
                } else {
                    throw new Error(data.message || 'Delete failed');
                }
            })
            .catch(error => {
                console.error('Failed to delete criteria:', error);
                ClaimsApp.utils.showNotification('Failed to delete criteria. Please try again.', 'error');
            });
        },
        () => {
            console.log('User cancelled criteria deletion');
        }
    );
}

</script>