<!-- Fixed Modal Template -->
<div class="fixed inset-0 z-50 overflow-y-auto">
    <!-- Backdrop - solid black overlay -->
    <div class="fixed inset-0 bg-black bg-opacity-75"></div>
    
    <!-- Modal Container -->
    <div class="relative min-h-screen flex items-center justify-center p-4">
        <div class="relative bg-white rounded-lg shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col">
            
            <!-- Header -->
            <div class="px-6 py-4 border-b bg-gray-50 rounded-t-lg flex-shrink-0">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900">Edit Rule</h2>
                        <p class="text-sm text-gray-600">{{RULE_NAME}} â€¢ Version {{VERSION}}</p>
                    </div>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                </div>
            </div>

            <form id="edit-rule-form" 
                  hx-put="https://bef4xsajbb.execute-api.us-east-1.amazonaws.com/dev/rules?update={{RULE_ID}}"
                  hx-target="#rules-container"
                  hx-trigger="submit"
                  hx-on::after-request="handleEditResponse(event)"
                  class="flex flex-col h-full">
                
                <div class="px-6 py-6 space-y-6 overflow-y-auto flex-1">
                    
                    <!-- Basic Info -->
                    <div class="grid grid-cols-4 gap-4">
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Rule Name</label>
                            <input type="text" name="name" value="{{RULE_NAME}}" class="w-full border rounded px-3 py-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Rule Type</label>
                            <select name="rule_type" onchange="toggleRuleType(this.value)" class="w-full border rounded px-3 py-2" required>
                                <option value="SIMPLE" {{SIMPLE_SELECTED}}>Simple</option>
                                <option value="COMPLEX" {{COMPLEX_SELECTED}}>Complex</option>
                                <option value="CLIENT" {{CLIENT_SELECTED}}>Client</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Flag Name</label>
                            <input type="text" name="flag_name" value="{{FLAG_NAME}}" class="w-full border rounded px-3 py-2" required>
                        </div>
                    </div>

                    <!-- COMPLEX RULE BUILDER -->
                    <div id="complex-section" class="hidden">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-blue-900 mb-4">Build Your Logic Visually</h3>
                            
                            <!-- Visual Expression Builder -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Your Rule Expression:</label>
                                <div id="expression-builder" class="min-h-[80px] p-4 bg-white border-2 border-dashed border-blue-300 rounded-lg flex flex-wrap items-center gap-2">
                                    <span id="empty-hint" class="text-blue-500 text-sm">Add flags below to build your expression...</span>
                                </div>
                            </div>

                            <!-- Simple Controls -->
                            <div class="space-y-4">
                                
                                <!-- Add Flag -->
                                <div class="flex items-end gap-3">
                                    <div class="flex-1">
                                        <label class="block text-xs font-medium text-gray-600 mb-1">Add Flag</label>
                                        <select id="flag-selector" class="w-full border rounded px-3 py-2">
                                            <option value="">Choose a flag...</option>
                                            {{AVAILABLE_FLAGS}}
                                        </select>
                                    </div>
                                    <button type="button" onclick="addFlag()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
                                        Add Flag
                                    </button>
                                </div>

                                <!-- Logic Operators - Separate parentheses -->
                                <div class="flex gap-2">
                                    <span class="text-sm text-gray-600 py-2">Add operators:</span>
                                    <button type="button" onclick="addOperator('AND')" class="bg-blue-600 text-white px-4 py-1 rounded text-sm hover:bg-blue-700">
                                        AND
                                    </button>
                                    <button type="button" onclick="addOperator('OR')" class="bg-purple-600 text-white px-4 py-1 rounded text-sm hover:bg-purple-700">
                                        OR
                                    </button>
                                    <button type="button" onclick="addOperator('NOT')" class="bg-red-600 text-white px-4 py-1 rounded text-sm hover:bg-red-700">
                                        NOT
                                    </button>
                                    <button type="button" onclick="addParenthesis('(')" class="bg-gray-600 text-white px-4 py-1 rounded text-sm hover:bg-gray-700">
                                        (
                                    </button>
                                    <button type="button" onclick="addParenthesis(')')" class="bg-gray-600 text-white px-4 py-1 rounded text-sm hover:bg-gray-700">
                                        )
                                    </button>
                                    <button type="button" onclick="clearExpression()" class="bg-red-100 text-red-700 px-4 py-1 rounded text-sm hover:bg-red-200 ml-auto">
                                        Clear All
                                    </button>
                                </div>

                                <!-- Live Preview -->
                                <div class="bg-gray-50 border rounded p-3">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-medium">Generated SQL:</span>
                                        <span id="status-indicator" class="text-xs px-2 py-1 rounded bg-green-100 text-green-700">Valid</span>
                                    </div>
                                    <div id="sql-preview" class="font-mono text-sm bg-white p-2 rounded border min-h-[30px]">
                                        {{CONDITIONS}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SIMPLE RULE BUILDER -->
                    <div id="simple-section">
                        <div class="space-y-4">
                            <!-- Data Source (only for simple rules) -->
                            <div id="data-source-field">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Source</label>
                                <select name="data_source" class="w-full border rounded px-3 py-2">
                                    <option value="">Select Source</option>
                                    {{DATA_SOURCE_OPTIONS}}
                                </select>
                            </div>

                            <!-- Simple SQL Input -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Conditions</label>
                                <textarea id="simple-conditions" class="w-full border rounded px-3 py-2 font-mono" rows="3" 
                                          placeholder="e.g., GPI6 = '393500'">{{CONDITIONS}}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden textarea for form submission -->
                    <textarea name="conditions" id="conditions-textarea" class="hidden">{{CONDITIONS}}</textarea>

                    <!-- Other Fields -->
                    <div class="grid grid-cols-6 gap-4 text-sm">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">PBM</label>
                            <select name="pbm_code" class="w-full border rounded px-2 py-1 text-sm" required>
                                {{PBM_OPTIONS}}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Priority</label>
                            <input type="number" name="priority" value="{{PRIORITY}}" class="w-full border rounded px-2 py-1 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Category</label>
                            <select name="rule_category" class="w-full border rounded px-2 py-1 text-sm">
                                <option value="PRODUCTION" {{PRODUCTION_SELECTED}}>Production</option>
                                <option value="MODELING" {{MODELING_SELECTED}}>Modeling</option>
                            </select>
                        </div>
                        <div class="flex items-center pt-5">
                            <input type="checkbox" name="is_standalone_executable" {{STANDALONE_CHECKED}} class="mr-2">
                            <span class="text-xs">Standalone</span>
                        </div>
                        <div class="flex items-center pt-5">
                            <input type="checkbox" name="is_active" {{ACTIVE_CHECKED}} class="mr-2">
                            <span class="text-xs">Active</span>
                        </div>
                        <div class="flex items-center pt-5">
                            <input type="checkbox" name="eligibility_types[]" value="REBATES" {{REBATES_CHECKED}} class="mr-2">
                            <span class="text-xs">Rebates</span>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="px-6 py-4 border-t bg-gray-50 rounded-b-lg flex justify-end gap-3 flex-shrink-0">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded text-gray-700 hover:bg-gray-100">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
console.log('Fixed modal script loading...');

let expressionParts = [];
let isInitialized = false;

function initializeModal() {
    if (isInitialized) return;
    
    console.log('Initializing modal...');
    const ruleType = document.querySelector('select[name="rule_type"]')?.value;
    if (ruleType) {
        toggleRuleType(ruleType);
    }
    isInitialized = true;
}

function toggleRuleType(type) {
    console.log('Toggling rule type to:', type);
    
    const complexSection = document.getElementById('complex-section');
    const simpleSection = document.getElementById('simple-section');
    const dataSourceField = document.getElementById('data-source-field');
    
    if (type === 'COMPLEX') {
        if (complexSection) complexSection.classList.remove('hidden');
        if (simpleSection) simpleSection.classList.add('hidden');
        if (dataSourceField) dataSourceField.style.display = 'none';
        loadExistingExpression();
    } else {
        if (complexSection) complexSection.classList.add('hidden');
        if (simpleSection) simpleSection.classList.remove('hidden');
        if (dataSourceField) dataSourceField.style.display = 'block';
        
        // For simple rules, sync the simple textarea with the hidden one
        const simpleTextarea = document.getElementById('simple-conditions');
        const hiddenTextarea = document.getElementById('conditions-textarea');
        if (simpleTextarea && hiddenTextarea) {
            simpleTextarea.addEventListener('input', function() {
                hiddenTextarea.value = this.value;
            });
        }
    }
}

function loadExistingExpression() {
    const textarea = document.getElementById('conditions-textarea');
    if (textarea && textarea.value.trim()) {
        // Parse the existing expression more carefully
        const existingCondition = textarea.value.trim();
        console.log('Loading existing expression:', existingCondition);
        
        // Split on spaces but preserve logical structure
        const parts = existingCondition.split(/\s+/);
        expressionParts = parts;
        updateExpressionDisplay();
        updateSQLPreview();
    }
}

function addFlag() {
    const selector = document.getElementById('flag-selector');
    const flag = selector.value;
    
    if (!flag) {
        alert('Please select a flag first');
        return;
    }
    
    expressionParts.push(flag);
    selector.value = '';
    updateExpressionDisplay();
    updateSQLPreview();
}

function addOperator(op) {
    if (expressionParts.length === 0 && op !== 'NOT') {
        alert('Add a flag first');
        return;
    }
    
    expressionParts.push(op);
    updateExpressionDisplay();
    updateSQLPreview();
}

function addParenthesis(paren) {
    expressionParts.push(paren);
    updateExpressionDisplay();
    updateSQLPreview();
}

function clearExpression() {
    expressionParts = [];
    updateExpressionDisplay();
    updateSQLPreview();
}

function removeToken(index) {
    expressionParts.splice(index, 1);
    updateExpressionDisplay();
    updateSQLPreview();
}

function updateExpressionDisplay() {
    const container = document.getElementById('expression-builder');
    const emptyHint = document.getElementById('empty-hint');
    
    if (!container) return;
    
    if (expressionParts.length === 0) {
        container.innerHTML = '<span id="empty-hint" class="text-blue-500 text-sm">Add flags below to build your expression...</span>';
        return;
    }
    
    const tokensHTML = expressionParts.map((part, index) => {
        let colorClass = 'bg-gray-200 text-gray-800';
        
        if (['AND', 'OR'].includes(part)) {
            colorClass = 'bg-blue-100 text-blue-800';
        } else if (part === 'NOT') {
            colorClass = 'bg-red-100 text-red-800';
        } else if (['(', ')'].includes(part)) {
            colorClass = 'bg-purple-100 text-purple-800';
        } else {
            colorClass = 'bg-green-100 text-green-800';
        }
        
        return `
            <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium ${colorClass}">
                ${part}
                <button type="button" onclick="removeToken(${index})" class="ml-1 text-current hover:bg-black hover:bg-opacity-20 rounded-full w-4 h-4 flex items-center justify-center text-xs">
                    Ã—
                </button>
            </span>
        `;
    }).join('');
    
    container.innerHTML = tokensHTML;
}

function updateSQLPreview() {
    const preview = document.getElementById('sql-preview');
    const textarea = document.getElementById('conditions-textarea');
    const status = document.getElementById('status-indicator');
    
    if (!preview || !textarea) return;
    
    const sql = expressionParts.join(' ');
    preview.textContent = sql || 'No conditions yet...';
    textarea.value = sql;
    
    if (sql.trim() && status) {
        const isValid = validateExpression(sql);
        status.textContent = isValid ? 'Valid' : 'Check syntax';
        status.className = `text-xs px-2 py-1 rounded ${isValid ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`;
    }
}

function validateExpression(expr) {
    let parenCount = 0;
    const tokens = expr.split(/\s+/);
    
    for (const token of tokens) {
        if (token === '(') parenCount++;
        if (token === ')') parenCount--;
        if (parenCount < 0) return false;
    }
    
    return parenCount === 0 && tokens.length > 0;
}

function handleEditResponse(event) {
    if (event.detail.successful) {
        closeModal();
        showNotification('Rule updated successfully!', 'success');
        // Refresh the rules table
        htmx.ajax('GET', 'https://bef4xsajbb.execute-api.us-east-1.amazonaws.com/dev/rules', {
            target: '#rules-container'
        });
    } else {
        showNotification('Failed to update rule. Please try again.', 'error');
    }
}

function showNotification(message, type) {
    // Simple notification - you can enhance this
    alert(message);
}

// Initialize when the script loads
setTimeout(initializeModal, 100);

</script>