<!-- Fixed Modal Template -->
<div class="fixed inset-0 z-50 overflow-y-auto">
    <!-- Backdrop - solid black overlay -->
    <div class="fixed inset-0 bg-black bg-opacity-75"></div>
    
    <!-- Modal Container -->
    <div class="relative min-h-screen flex items-center justify-center p-4">
        <div class="relative bg-white rounded-lg shadow-2xl w-full max-w-[95vw] h-screen flex flex-col">
            
            <!-- Header -->
            <div class="px-6 py-4 border-b bg-gray-50 rounded-t-lg flex-shrink-0">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900">Edit Rule</h2>
                        <p class="text-sm text-gray-600">{{RULE_NAME}} â€¢ Version {{VERSION}}</p>
                    </div>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                </div>
            </div>

            <form id="edit-rule-form" 
                  hx-put="https://bef4xsajbb.execute-api.us-east-1.amazonaws.com/dev/rules?update={{RULE_ID}}"
                  hx-target="#rules-container"
                  hx-trigger="submit"
                  hx-on::after-request="handleEditResponse(event)"
                  class="flex flex-col h-full">
                
                <div class="px-6 py-6 space-y-6 overflow-y-auto flex-1">
                    
                    <!-- Basic Info - READ ONLY FIELDS -->
                    <div class="grid grid-cols-4 gap-4">
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Rule Name</label>
                            <input type="text" name="name" value="{{RULE_NAME}}" 
                                   class="w-full border rounded px-3 py-2 bg-gray-100 text-gray-600" 
                                   readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Rule Type</label>
                            <input type="text" value="{{RULE_TYPE}}" 
                                   class="w-full border rounded px-3 py-2 bg-gray-100 text-gray-600" 
                                   readonly>
                            <input type="hidden" name="rule_type" value="{{RULE_TYPE}}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Flag Name</label>
                            <input type="text" name="flag_name" value="{{FLAG_NAME}}" 
                                   class="w-full border rounded px-3 py-2 bg-gray-100 text-gray-600" 
                                   readonly>
                        </div>
                    </div>

                    <!-- COMPLEX RULE BUILDER -->
                    <div id="complex-section" class="hidden">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-blue-900 mb-4">Build Your Logic Visually</h3>
                            
                            <!-- Visual Expression Builder -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Your Rule Expression:</label>
                                <div id="expression-builder" class="min-h-[80px] p-4 bg-white border-2 border-dashed border-blue-300 rounded-lg flex flex-wrap items-center gap-2">
                                    <span id="empty-hint" class="text-blue-500 text-sm">Add flags below to build your expression...</span>
                                </div>
                            </div>

                            <!-- Simple Controls -->
                            <div class="space-y-4">
                                
                                <!-- Add Flag -->
                                <div class="flex items-end gap-3">
                                    <div class="flex-1">
                                        <label class="block text-xs font-medium text-gray-600 mb-1">Add Flag</label>
                                        <select id="flag-selector" class="w-full border rounded px-3 py-2">
                                            <option value="">Choose a flag...</option>
                                            {{AVAILABLE_FLAGS}}
                                        </select>
                                    </div>
                                    <button type="button" onclick="addFlag()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
                                        Add Flag
                                    </button>
                                </div>

                                <!-- Logic Operators - Separate parentheses -->
                                <div class="flex gap-2">
                                    <span class="text-sm text-gray-600 py-2">Add operators:</span>
                                    <button type="button" onclick="addOperator('AND')" class="bg-blue-600 text-white px-4 py-1 rounded text-sm hover:bg-blue-700">
                                        AND
                                    </button>
                                    <button type="button" onclick="addOperator('OR')" class="bg-purple-600 text-white px-4 py-1 rounded text-sm hover:bg-purple-700">
                                        OR
                                    </button>
                                    <button type="button" onclick="addOperator('NOT')" class="bg-red-600 text-white px-4 py-1 rounded text-sm hover:bg-red-700">
                                        NOT
                                    </button>
                                    <button type="button" onclick="addParenthesis('(')" class="bg-gray-600 text-white px-4 py-1 rounded text-sm hover:bg-gray-700">
                                        (
                                    </button>
                                    <button type="button" onclick="addParenthesis(')')" class="bg-gray-600 text-white px-4 py-1 rounded text-sm hover:bg-gray-700">
                                        )
                                    </button>
                                    <button type="button" onclick="clearExpression()" class="bg-red-100 text-red-700 px-4 py-1 rounded text-sm hover:bg-red-200 ml-auto">
                                        Clear All
                                    </button>
                                </div>

                                <!-- Live Preview -->
                                <div class="bg-gray-50 border rounded p-3">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-medium">Generated SQL:</span>
                                        <span id="status-indicator" class="text-xs px-2 py-1 rounded bg-green-100 text-green-700">Valid</span>
                                    </div>
                                    <div id="sql-preview" class="font-mono text-sm bg-white p-2 rounded border min-h-[30px]">
                                        {{CONDITIONS}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SIMPLE RULE BUILDER - FIXED VERSION -->
                    <div id="simple-section">
                        <div class="space-y-4">
                            <!-- FIXED: Data Source dropdown with HTMX field loading -->
                            <div id="data-source-field">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Source</label>
                                <select name="data_source" 
                                        onchange="handleDataSourceChange(this.value)"
                                        class="w-full border rounded px-3 py-2">
                                    <option value="">Select Data Source</option>
                                    {{DATA_SOURCE_OPTIONS}}
                                </select>
                            </div>

                            <!-- FIXED: Visual Builder with HTMX-powered field dropdown -->
                            <div class="bg-gray-50 border border-gray-200 rounded-md p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="text-md font-medium text-gray-800">ðŸ”§ Visual Condition Builder</h4>
                                    <button type="button" 
                                            onclick="clearAllConditions()"
                                            class="text-sm bg-red-100 text-red-700 px-3 py-1 rounded hover:bg-red-200">
                                        Clear All
                                    </button>
                                </div>
                                
                                <div class="space-y-3">
                                    <!-- FIXED: Add Condition Row with dynamic field loading -->
                                    <div class="flex items-center space-x-3">
                                        <select id="field-select" 
                                                onchange="handleFieldSelection(this.value)"
                                                class="border border-gray-300 rounded px-3 py-2 min-w-[200px]">
                                            <option value="">Select Data Source First</option>
                                            {{DATASOURCE_FIELDS}}
                                        </select>
                                        <select id="operator-select" class="border border-gray-300 rounded px-3 py-2">
                                            <option value="=">=</option>
                                            <option value="!=">!=</option>
                                            <option value="IN">IN</option>
                                            <option value="NOT IN">NOT IN</option>
                                            <option value="LIKE">LIKE</option>
                                            <option value="NOT LIKE">NOT LIKE</option>
                                            <option value=">">&gt;</option>
                                            <option value="<">&lt;</option>
                                            <option value=">=">&gt;=</option>
                                            <option value="<=">&lt;=</option>
                                        </select>
                                        <input type="text" 
                                               id="value-input" 
                                               class="border border-gray-300 rounded px-3 py-2 flex-1"
                                               placeholder="Enter value(s)">
                                        <button type="button" 
                                                onclick="buildCondition()"
                                                class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 whitespace-nowrap">
                                            Build Condition
                                        </button>
                                    </div>
                                    
                                    <!-- Built Conditions Display -->
                                    <div class="bg-white border rounded p-3 min-h-[60px]">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-medium text-gray-700">Built Conditions:</span>
                                            <span id="condition-count" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">0 conditions</span>
                                        </div>
                                        <div id="built-conditions" class="space-y-2">
                                            <span class="text-gray-500 text-sm">No conditions added yet...</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Final SQL Preview -->
                                    <div class="bg-gray-50 border rounded p-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-medium">Final SQL Preview:</span>
                                            <span id="sql-status" class="text-xs px-2 py-1 rounded bg-green-100 text-green-700">Ready</span>
                                        </div>
                                        <div id="final-sql-preview" class="font-mono text-sm bg-white p-2 rounded border min-h-[30px] text-gray-600">
                                            {{CONDITIONS}}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden textarea for form submission -->
                    <textarea name="conditions" id="conditions-textarea" class="hidden">{{CONDITIONS}}</textarea>

                    <!-- Other Fields -->
                    <div class="grid grid-cols-6 gap-4 text-sm">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">PBM</label>
                            <select name="pbm_code" class="w-full border rounded px-2 py-1 text-sm" required>
                                {{PBM_OPTIONS}}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Priority</label>
                            <input type="number" name="priority" value="{{PRIORITY}}" class="w-full border rounded px-2 py-1 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Category</label>
                            <select name="rule_category" class="w-full border rounded px-2 py-1 text-sm">
                                <option value="PRODUCTION" {{PRODUCTION_SELECTED}}>Production</option>
                                <option value="MODELING" {{MODELING_SELECTED}}>Modeling</option>
                            </select>
                        </div>
                        <div class="flex items-center pt-5">
                            <input type="checkbox" name="is_standalone_executable" {{STANDALONE_CHECKED}} class="mr-2">
                            <span class="text-xs">Standalone</span>
                        </div>
                        <div class="flex items-center pt-5">
                            <input type="checkbox" name="is_active" {{ACTIVE_CHECKED}} class="mr-2">
                            <span class="text-xs">Active</span>
                        </div>
                        <!-- FIXED: Multi-select Eligibility Type -->
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Eligibility Types</label>
                            <select name="eligibility_types" multiple 
                                    class="w-full border rounded px-2 py-1 text-sm h-20" 
                                    style="min-height: 60px;">
                                {{ELIGIBILITY_OPTIONS}}
                            </select>
                            <div class="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple</div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="px-6 py-4 border-t bg-gray-50 rounded-b-lg flex justify-end gap-3 flex-shrink-0">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded text-gray-700 hover:bg-gray-100">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
console.log('Fixed modal script loading...');

// FIXED: Wrap in IIFE to avoid variable conflicts but keep ALL functionality
(function() {
    // Clear any existing modal state
    window.modalState = window.modalState || {};
    
    let expressionParts = window.modalState.expressionParts || [];
    let builtConditions = window.modalState.builtConditions || [];
    let isInitialized = window.modalState.isInitialized || false;
    
    // Store state globally so HTMX updates don't lose it
    function updateState() {
        window.modalState.expressionParts = expressionParts;
        window.modalState.builtConditions = builtConditions;
        window.modalState.isInitialized = isInitialized;
    }

    function initializeModal() {
        console.log('Initializing modal...');
        
        // FIXED: Always reset state when initializing a new modal
        expressionParts = [];
        builtConditions = [];
        isInitialized = false;
        
        const ruleType = document.querySelector('input[name="rule_type"]')?.value;
        if (ruleType) {
            toggleRuleType(ruleType);
        }
        loadExistingConditions();
        isInitialized = true;
        updateState();
    }

    function toggleRuleType(type) {
        console.log('Toggling rule type to:', type);
        
        // FIXED: Reset all state when switching rule types
        expressionParts = [];
        builtConditions = [];
        
        const complexSection = document.getElementById('complex-section');
        const simpleSection = document.getElementById('simple-section');
        const dataSourceField = document.getElementById('data-source-field');
        
        if (type === 'COMPLEX') {
            if (complexSection) complexSection.classList.remove('hidden');
            if (simpleSection) simpleSection.classList.add('hidden');
            if (dataSourceField) dataSourceField.style.display = 'none';
            
            // Clear simple rule artifacts
            clearAllConditions();
            
            loadExistingExpression();
        } else {
            if (complexSection) complexSection.classList.add('hidden');
            if (simpleSection) simpleSection.classList.remove('hidden');
            if (dataSourceField) dataSourceField.style.display = 'block';
            
            // Clear complex rule artifacts
            clearExpression();
        }
        
        updateState();
    }

    function loadExistingConditions() {
        const textarea = document.getElementById('conditions-textarea');
        if (textarea && textarea.value.trim()) {
            const existingCondition = textarea.value.trim();
            console.log('Loading existing conditions:', existingCondition);
            
            // Parse existing conditions and display them
            updateFinalSQLPreview(existingCondition);
        }
    }

    function loadExistingExpression() {
        const textarea = document.getElementById('conditions-textarea');
        if (textarea && textarea.value.trim()) {
            const existingCondition = textarea.value.trim();
            console.log('Loading existing expression:', existingCondition);
            
            const parts = existingCondition.split(/\s+/);
            expressionParts = parts;
            updateExpressionDisplay();
            updateSQLPreview();
            updateState();
        }
    }

    // FIXED: Simple Rule Builder Functions - Simplified without AND/OR
    function buildCondition() {
        const field = document.getElementById('field-select')?.value;
        const operator = document.getElementById('operator-select')?.value;
        const value = document.getElementById('value-input')?.value;
        
        if (!field || !operator || !value) {
            alert('Please fill in all fields first!');
            return;
        }
        
        let newCondition = `${field} ${operator} `;
        if (operator.includes('IN')) {
            const values = value.split(',').map(v => `'${v.trim()}'`).join(', ');
            newCondition += `(${values})`;
        } else if (operator.includes('LIKE')) {
            newCondition += `'%${value}%'`;
        } else {
            newCondition += `'${value}'`;
        }
        
        // FIXED: Only store one condition for simple rules
        builtConditions = [{
            field: field,
            operator: operator,
            value: value,
            condition: newCondition
        }];
        
        updateBuiltConditionsDisplay();
        clearConditionInputs();
        updateState();
    }

    function removeCondition(index) {
        builtConditions.splice(index, 1);
        updateBuiltConditionsDisplay();
        updateState();
    }

    function clearAllConditions() {
        builtConditions = [];
        updateBuiltConditionsDisplay();
        clearConditionInputs();
        updateState();
    }

    function clearConditionInputs() {
        const fieldSelect = document.getElementById('field-select');
        const operatorSelect = document.getElementById('operator-select');
        const valueInput = document.getElementById('value-input');
        
        if (fieldSelect) fieldSelect.value = '';
        if (operatorSelect) operatorSelect.value = '=';
        if (valueInput) valueInput.value = '';
    }

    function updateBuiltConditionsDisplay() {
        const container = document.getElementById('built-conditions');
        const countSpan = document.getElementById('condition-count');
        
        if (!container) return;
        
        const conditionCount = builtConditions.length;
        if (countSpan) {
            countSpan.textContent = `${conditionCount} condition${conditionCount !== 1 ? 's' : ''}`;
        }
        
        if (builtConditions.length === 0) {
            container.innerHTML = '<span class="text-gray-500 text-sm">No conditions added yet...</span>';
            updateFinalSQLPreview('');
            return;
        }
        
        // FIXED: Simple display without operators
        const conditionsHTML = builtConditions.map((condition, index) => {
            return `
                <span class="inline-flex items-center gap-1 px-3 py-1 rounded bg-green-100 text-green-800 text-sm">
                    ${condition.field} ${condition.operator} ${condition.value}
                    <button type="button" onclick="window.removeCondition(${index})" class="ml-1 text-green-600 hover:text-green-800 text-xs">Ã—</button>
                </span>
            `;
        }).join(' ');
        
        container.innerHTML = conditionsHTML;
        
        // Build final SQL (just the single condition)
        const finalSQL = builtConditions.map(c => c.condition).join('');
        updateFinalSQLPreview(finalSQL);
    }

    function updateFinalSQLPreview(sql) {
        const preview = document.getElementById('final-sql-preview');
        const textarea = document.getElementById('conditions-textarea');
        const status = document.getElementById('sql-status');
        
        if (!preview || !textarea) return;
        
        if (sql.trim()) {
            preview.textContent = sql;
            preview.className = 'font-mono text-sm bg-white p-2 rounded border min-h-[30px] text-gray-900';
            textarea.value = sql;
            
            if (status) {
                status.textContent = 'Valid';
                status.className = 'text-xs px-2 py-1 rounded bg-green-100 text-green-700';
            }
        } else {
            preview.textContent = 'No conditions set...';
            preview.className = 'font-mono text-sm bg-white p-2 rounded border min-h-[30px] text-gray-500';
            textarea.value = '';
            
            if (status) {
                status.textContent = 'Empty';
                status.className = 'text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-700';
            }
        }
    }

    // FIXED: Handle field selection - no longer needs data source filtering since it's already filtered
    function handleFieldSelection(fieldValue) {
        console.log('Field selected:', fieldValue);
        // Just log it for now - field is already filtered by data source in backend
    }

    // FIXED: Handle data source change - now with proper HTMX integration
    function handleDataSourceChange(dataSource) {
    console.log('Data source changed to:', dataSource);
    
    const fieldSelect = document.getElementById('field-select');
    
    if (!dataSource) {
        // No data source selected
        if (fieldSelect) {
            fieldSelect.innerHTML = '<option value="">Select Data Source First</option>';
        }
        clearAllConditions();
        return;
    }
    
    // Clear existing conditions since we're changing data source
    clearAllConditions();
    
    // Show loading state
    if (fieldSelect) {
        fieldSelect.innerHTML = '<option value="">Loading fields...</option>';
        fieldSelect.disabled = true;
    }
    
    // THIS IS THE MISSING PART - Make simple HTMX GET request
    const url = `https://bef4xsajbb.execute-api.us-east-1.amazonaws.com/dev/rules?get_fields=true&data_source=${encodeURIComponent(dataSource)}`;
    
    console.log('Making HTMX request to:', url);
    
    htmx.ajax('GET', url, {
        target: '#field-select',
        swap: 'innerHTML'
    }).then(() => {
        console.log('Fields loaded successfully!');
        if (fieldSelect) {
            fieldSelect.disabled = false;
        }
        showNotification('Fields loaded successfully!', 'success');
    }).catch((error) => {
        console.error('Failed to load fields:', error);
        if (fieldSelect) {
            fieldSelect.innerHTML = '<option value="">Error loading fields</option>';
            fieldSelect.disabled = false;
        }
        showNotification('Failed to load fields. Please try again.', 'error');
    });
}

    // Complex Rule Builder Functions (keeping ALL existing functionality)
    function addFlag() {
        const selector = document.getElementById('flag-selector');
        const flag = selector.value;
        
        if (!flag) {
            alert('Pick a flag first!');
            return;
        }
        
        expressionParts.push(flag);
        selector.value = '';
        updateExpressionDisplay();
        updateSQLPreview();
        updateState();
    }

    function addOperator(op) {
        if (expressionParts.length === 0 && op !== 'NOT') {
            alert('Add a flag first!');
            return;
        }
        
        expressionParts.push(op);
        updateExpressionDisplay();
        updateSQLPreview();
        updateState();
    }

    function addParenthesis(paren) {
        expressionParts.push(paren);
        updateExpressionDisplay();
        updateSQLPreview();
        updateState();
    }

    function clearExpression() {
        expressionParts = [];
        updateExpressionDisplay();
        updateSQLPreview();
        updateState();
    }

    function removeToken(index) {
        expressionParts.splice(index, 1);
        updateExpressionDisplay();
        updateSQLPreview();
        updateState();
    }

    function updateExpressionDisplay() {
        const container = document.getElementById('expression-builder');
        
        if (!container) return;
        
        if (expressionParts.length === 0) {
            container.innerHTML = '<span id="empty-hint" class="text-blue-500 text-sm">Add flags below to build your expression...</span>';
            return;
        }
        
        const tokensHTML = expressionParts.map((part, index) => {
            let colorClass = 'bg-gray-200 text-gray-800';
            
            if (['AND', 'OR'].includes(part)) {
                colorClass = 'bg-blue-100 text-blue-800';
            } else if (part === 'NOT') {
                colorClass = 'bg-red-100 text-red-800';
            } else if (['(', ')'].includes(part)) {
                colorClass = 'bg-purple-100 text-purple-800';
            } else {
                colorClass = 'bg-green-100 text-green-800';
            }
            
            return `
                <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium ${colorClass}">
                    ${part}
                    <button type="button" onclick="window.removeToken(${index})" class="ml-1 text-current hover:bg-black hover:bg-opacity-20 rounded-full w-4 h-4 flex items-center justify-center text-xs">
                        Ã—
                    </button>
                </span>
            `;
        }).join('');
        
        container.innerHTML = tokensHTML;
    }

    function updateSQLPreview() {
        const preview = document.getElementById('sql-preview');
        const textarea = document.getElementById('conditions-textarea');
        const status = document.getElementById('status-indicator');
        
        if (!preview || !textarea) return;
        
        const sql = expressionParts.join(' ');
        preview.textContent = sql || 'No conditions yet...';
        textarea.value = sql;
        
        if (sql.trim() && status) {
            const isValid = validateExpression(sql);
            status.textContent = isValid ? 'Valid' : 'Check syntax';
            status.className = `text-xs px-2 py-1 rounded ${isValid ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`;
        }
    }

    function validateExpression(expr) {
        let parenCount = 0;
        const tokens = expr.split(/\s+/);
        
        for (const token of tokens) {
            if (token === '(') parenCount++;
            if (token === ')') parenCount--;
            if (parenCount < 0) return false;
        }
        
        return parenCount === 0 && tokens.length > 0;
    }

    // Make functions globally available for onclick handlers
    window.buildCondition = buildCondition;
    window.removeCondition = removeCondition;
    window.clearAllConditions = clearAllConditions;
    window.handleFieldSelection = handleFieldSelection;
    window.handleDataSourceChange = handleDataSourceChange;
    //window.loadFieldsForDataSource = loadFieldsForDataSource;  // Add this too
    
    // Complex rule functions
    window.addFlag = addFlag;
    window.addOperator = addOperator;
    window.addParenthesis = addParenthesis;
    window.clearExpression = clearExpression;
    window.removeToken = removeToken;

    // Initialize when the script loads
    setTimeout(initializeModal, 100);

})(); // End IIFE

// ENHANCED: Handle HTMX after request to re-enable dropdown
document.body.addEventListener('htmx:afterRequest', function(event) {
    console.log('HTMX request completed:', event.detail);
    
    // Re-enable field select after HTMX loads new options
    const fieldSelect = document.getElementById('field-select');
    if (fieldSelect && event.detail.target === fieldSelect) {
        fieldSelect.disabled = false;
        console.log('Field dropdown re-enabled with new options');
        
        // Check if we got fields or an error
        if (fieldSelect.options.length <= 1) {
            console.warn('No fields loaded for selected data source');
            showNotification('No fields found for this data source', 'warning');
        } else {
            console.log('Successfully loaded', fieldSelect.options.length - 1, 'fields');
            showNotification('Fields loaded successfully!', 'success');
        }
    }
});

// ENHANCED: Handle HTMX errors gracefully
document.body.addEventListener('htmx:responseError', function(event) {
    console.error('HTMX error:', event.detail);
    
    const fieldSelect = document.getElementById('field-select');
    if (fieldSelect && event.detail.target === fieldSelect) {
        fieldSelect.innerHTML = '<option value="">Error loading fields</option>';
        fieldSelect.disabled = false;
        showNotification('Failed to load fields. Please try again.', 'error');
    }
});

// Helper function for notifications
function showNotification(message, type = 'info') {
    console.log(`[${type.toUpperCase()}] ${message}`);
    
    // Create a simple toast notification
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-4 py-2 rounded shadow-lg z-50 ${getNotificationClass(type)}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

function getNotificationClass(type) {
    const classes = {
        'success': 'bg-green-100 text-green-800 border border-green-200',
        'error': 'bg-red-100 text-red-800 border border-red-200',
        'warning': 'bg-yellow-100 text-yellow-800 border border-yellow-200',
        'info': 'bg-blue-100 text-blue-800 border border-blue-200'
    };
    return classes[type] || classes['info'];
}

function handleEditResponse(event) {
    if (event.detail.successful) {
        closeModal();
        showNotification('Rule updated successfully! ðŸŽ‰', 'success');
        htmx.ajax('GET', 'https://bef4xsajbb.execute-api.us-east-1.amazonaws.com/dev/rules', {
            target: '#rules-container'
        });
    } else {
        showNotification('Failed to update rule. Try again!', 'error');
    }
}

</script>