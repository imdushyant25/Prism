<!-- Add Rule Modal -->
<div id="add-rule-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50"
     style="padding-top: 2rem; padding-bottom: 2rem;"
     onclick="if(event.target === this) closeAddRuleModal()">

    <!-- Modal Container -->
    <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-full overflow-hidden"
         onclick="event.stopPropagation()">

        <!-- Header -->
        <div class="px-6 py-4 border-b bg-gray-50 rounded-t-lg flex-shrink-0">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-900">Add New Enrichment Rule</h2>
                <button onclick="closeAddRuleModal()" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
        </div>

        <form id="add-rule-form"
              hx-post="https://bef4xsajbb.execute-api.us-east-1.amazonaws.com/dev/rules?action=create"
              hx-target="#rules-container"
              hx-trigger="submit"
              hx-on::after-request="handleAddRuleResponse(event)"
              class="flex flex-col" style="height: calc(100vh - 8rem);">

            <!-- Form Content -->
            <div class="px-6 py-6 overflow-y-auto flex-1">
                <div class="grid grid-cols-3 gap-8">

                    <!-- LEFT COLUMN - Rule Builder (60% width) -->
                    <div class="col-span-2 space-y-6">

                        <!-- Basic Information -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-blue-900 mb-4">Basic Information</h3>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="add_rule_name" class="block text-sm font-medium text-gray-700 mb-2">Rule Name *</label>
                                    <input type="text" id="add_rule_name" name="rule_name" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>

                                <div>
                                    <label for="add_flag_name" class="block text-sm font-medium text-gray-700 mb-2">Flag Name *</label>
                                    <input type="text" id="add_flag_name" name="flag_name" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>

                                <div>
                                    <label for="add_pbm_code" class="block text-sm font-medium text-gray-700 mb-2">PBM *</label>
                                    <select id="add_pbm_code" name="pbm_code" required
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        {{PBM_OPTIONS}}
                                    </select>
                                </div>

                                <div>
                                    <label for="add_rule_type" class="block text-sm font-medium text-gray-700 mb-2">Rule Type *</label>
                                    <select id="add_rule_type" name="rule_type" required onchange="handleRuleTypeChange(this.value)"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Select Type</option>
                                        <option value="SIMPLE">Simple Rule</option>
                                        <option value="COMPLEX">Complex Rule</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Rule Logic Builder -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-blue-900 mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.781 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 9.586V5L8 4z"></path>
                                </svg>
                                Rule Logic Builder
                            </h3>

                            <!-- COMPLEX RULE BUILDER -->
                            <div id="complex-section" class="hidden">
                                <!-- Visual Expression Builder -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Your Rule Expression:</label>
                                    <div id="expression-builder" class="min-h-[60px] p-3 bg-gray-50 border-2 border-dashed border-blue-300 rounded-lg flex flex-wrap items-center gap-2">
                                        <span id="empty-hint" class="text-blue-500 text-sm">Add flags below to build your expression...</span>
                                    </div>
                                </div>

                                <!-- Controls -->
                                <div class="space-y-3">
                                    <!-- Add Flag -->
                                    <div class="flex items-center gap-2">
                                        <select id="flag-selector" class="flex-1 border rounded px-3 py-2 text-sm">
                                            <option value="">Choose a flag...</option>
                                            {{AVAILABLE_FLAGS}}
                                        </select>
                                        <button type="button" onclick="addFlag()" class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700">
                                            Add Flag
                                        </button>
                                    </div>

                                    <!-- Logic Operators -->
                                    <div class="flex flex-wrap gap-2">
                                        <span class="text-sm text-gray-600 py-1">Operators:</span>
                                        <button type="button" onclick="addOperator('AND')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">AND</button>
                                        <button type="button" onclick="addOperator('OR')" class="bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700">OR</button>
                                        <button type="button" onclick="addOperator('NOT')" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">NOT</button>
                                        <button type="button" onclick="addParenthesis('(')" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">(</button>
                                        <button type="button" onclick="addParenthesis(')')" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">)</button>
                                        <button type="button" onclick="clearExpression()" class="bg-red-100 text-red-700 px-3 py-1 rounded text-sm hover:bg-red-200 ml-auto">Clear</button>
                                    </div>

                                    <!-- Live Preview -->
                                    <div class="bg-gray-50 border rounded p-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-medium">Generated SQL:</span>
                                            <span id="status-indicator" class="text-xs px-2 py-1 rounded bg-green-100 text-green-700">Valid</span>
                                        </div>
                                        <div id="sql-preview" class="font-mono text-sm bg-white p-2 rounded border min-h-[30px]">
                                            <!-- SQL preview will be generated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- SIMPLE RULE BUILDER -->
                            <div id="simple-section" class="hidden">
                                <div class="space-y-4">
                                    <!-- Data Source -->
                                    <div id="data-source-field" class="flex items-center gap-3">
                                        <label class="text-sm font-medium text-gray-700 w-24 flex-shrink-0">Data Source:</label>
                                        <select name="data_source"
                                                onchange="handleDataSourceChange(this.value)"
                                                class="flex-1 border rounded px-3 py-2">
                                            <option value="">Select Data Source</option>
                                            {{DATA_SOURCE_OPTIONS}}
                                        </select>
                                    </div>

                                    <!-- Condition Builder -->
                                    <div class="bg-gray-50 border border-gray-200 rounded-md p-4">
                                        <div class="flex justify-between items-center mb-3">
                                            <h4 class="text-sm font-medium text-gray-800">Visual Condition Builder</h4>
                                            <button type="button"
                                                    onclick="clearAllConditions()"
                                                    class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200">
                                                Clear
                                            </button>
                                        </div>

                                        <!-- Add Condition Row -->
                                        <div class="grid grid-cols-4 gap-2 mb-3">
                                            <select id="field-select"
                                                    onchange="handleFieldSelection(this.value)"
                                                    class="border border-gray-300 rounded px-2 py-2 text-sm">
                                                <option value="">Select Field</option>
                                                {{DATASOURCE_FIELDS}}
                                            </select>
                                            <select id="operator-select" class="border border-gray-300 rounded px-2 py-2 text-sm">
                                                <option value="=">=</option>
                                                <option value="!=">!=</option>
                                                <option value="IN">IN</option>
                                                <option value="NOT IN">NOT IN</option>
                                                <option value="LIKE">LIKE</option>
                                                <option value="NOT LIKE">NOT LIKE</option>
                                            </select>
                                            <input type="text"
                                                   id="value-input"
                                                   class="border border-gray-300 rounded px-2 py-2 text-sm"
                                                   placeholder="Value">
                                            <button type="button"
                                                    onclick="buildCondition()"
                                                    class="bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700">
                                                Add
                                            </button>
                                        </div>

                                        <!-- Built Conditions -->
                                        <div class="bg-white border rounded p-3 mb-3">
                                            <div class="flex justify-between items-center mb-2">
                                                <span class="text-xs font-medium text-gray-700">Conditions:</span>
                                                <span id="condition-count" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">0</span>
                                            </div>
                                            <div id="built-conditions">
                                                <span class="text-gray-500 text-sm">No conditions yet...</span>
                                            </div>
                                        </div>

                                        <!-- SQL Preview -->
                                        <div class="bg-gray-50 border rounded p-3">
                                            <div class="flex justify-between items-center mb-2">
                                                <span class="text-xs font-medium">SQL Preview:</span>
                                                <span id="sql-status" class="text-xs px-2 py-1 rounded bg-green-100 text-green-700">Ready</span>
                                            </div>
                                            <div id="final-sql-preview" class="font-mono text-xs bg-white p-2 rounded border min-h-[30px] text-gray-600">
                                                <!-- SQL preview will be shown here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden textarea for final conditions -->
                        <textarea name="conditions" id="conditions-textarea" class="hidden"></textarea>

                    </div>

                    <!-- RIGHT COLUMN - Settings (40% width) -->
                    <div class="space-y-6">

                        <!-- Rule Settings -->
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Rule Settings</h3>

                            <div class="space-y-4">
                                <div>
                                    <label for="add_priority" class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                                    <input type="number" id="add_priority" name="priority" min="1" value="100"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>

                                <div>
                                    <label for="add_rule_category" class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                    <select id="add_rule_category" name="rule_category"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="PRODUCTION">Production</option>
                                        <option value="MODELING">Modeling</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Eligibility Types -->
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-yellow-900 mb-4">Eligibility Types</h3>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" name="eligibility_types" value="REBATE_ELIGIBLE" checked
                                           class="rounded border-gray-300 mr-2">
                                    <span class="text-sm">Rebate Eligible</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="eligibility_types" value="REBATE_INELIGIBLE"
                                           class="rounded border-gray-300 mr-2">
                                    <span class="text-sm">Rebate Ineligible</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="eligibility_types" value="DISCOUNT_ELIGIBLE"
                                           class="rounded border-gray-300 mr-2">
                                    <span class="text-sm">Discount Eligible</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="eligibility_types" value="DISCOUNT_INELIGIBLE"
                                           class="rounded border-gray-300 mr-2">
                                    <span class="text-sm">Discount Ineligible</span>
                                </label>
                            </div>
                        </div>

                        <!-- Status -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-green-900 mb-4">Status</h3>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" name="is_active" checked
                                           class="rounded border-gray-300 mr-2">
                                    <span class="text-sm font-medium">Active Rule</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="is_standalone_executable"
                                           class="rounded border-gray-300 mr-2">
                                    <span class="text-sm">Standalone Executable</span>
                                </label>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="px-6 py-4 border-t bg-gray-50 flex justify-end space-x-3 flex-shrink-0">
                <button type="button" onclick="closeAddRuleModal()"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                    Cancel
                </button>
                <button type="submit"
                        class="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                    Create Rule
                </button>
            </div>

        </form>
    </div>
</div>