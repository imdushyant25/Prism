<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claims Enrichment Rules Management</title>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .modal { 
    display: none; 
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 50;
    background-color: rgba(0, 0, 0, 0.5);
    padding: 20px;
    box-sizing: border-box;
    overflow-y: auto;
    /* Prevent background scroll */
    overscroll-behavior: contain;
}

.modal.show { 
    display: flex; 
    align-items: flex-start;
    justify-content: center;
    /* Ensure modal starts at top with some padding */
    padding-top: 40px;
}

/* Prevent body scroll when modal is open */
body.modal-open {
    overflow: hidden;
    height: 100vh;
}

/* Enhanced modal content positioning */
.modal .bg-white {
    position: relative;
    margin: auto 0;
    min-height: 0; /* Allow flexbox to work properly */
}

/* Better scrolling for modal content */
.modal .overflow-y-auto {
    max-height: calc(90vh - 120px); /* Account for header and footer */
}

.filter-badge {
    animation: slideIn 0.2s ease-out;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateX(-10px); }
    to { opacity: 1; transform: translateX(0); }
}

.collapse {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
}

.expand {
    max-height: 500px;
    transition: max-height 0.3s ease-in;
}
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-6">
        <!-- Simplified Header - NO PBM selector, NO New Rule button -->
        <div class="bg-white rounded-lg border p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Claims Enrichment Rules</h1>
                    <p class="text-gray-600 mt-2">Manage your claim enrichment business rules across PBMs</p>
                </div>
            </div>
        </div>

        <!-- Filters Container - Load dynamically -->
        <div id="filters-container" 
             hx-get="https://bef4xsajbb.execute-api.us-east-1.amazonaws.com/dev/rules?component=filters" 
             hx-trigger="load">
            <!-- Filters will load here -->
            <div class="bg-white rounded-lg border p-4">
                <div class="text-center text-gray-500">Loading filters...</div>
            </div>
        </div>

        <!-- Rules Container -->
        <div id="rules-container">
            <div class="bg-white rounded-lg border p-8">
                <div class="text-center text-gray-500">
                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Select Filters to View Rules</h3>
                    <p class="text-gray-500">Use the filters above to load and manage enrichment rules</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for New/Edit Rule -->
    <div id="rule-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-[95vw] w-full mx-4 h-screen overflow-y-auto">
            <div id="modal-content">
                <!-- Modal content will load here via HTMX -->
            </div>
        </div>
    </div>

    <!-- Notification Area -->
    <div id="notification" class="fixed top-4 right-4 z-50">
        <!-- Success/error messages will appear here -->
    </div>

    <script>
        // Close modal
    function closeModal() {
            const modal = document.getElementById('rule-modal');
            const modalContent = document.getElementById('modal-content');
            
            if (modal) {
                modal.classList.remove('show');
                // Re-enable body scroll
                document.body.classList.remove('modal-open');
                document.body.style.overflow = 'auto';
                
                // CRITICAL: Clear modal content to prevent caching issues
                if (modalContent) {
                    console.log('üßπ Clearing modal content to prevent cache issues');
                    modalContent.innerHTML = `
                        <div class="p-8 text-center">
                            <div class="text-gray-500">Modal closed</div>
                        </div>
                    `;
                }
                
                // Clear any global modal state
                if (window.modalState) {
                    console.log('üßπ Clearing modal state');
                    window.modalState = {};
                }
            }
    }
 
    // Close modal when clicking outside
        document.getElementById('rule-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // HTMX event handlers
        document.body.addEventListener('htmx:responseError', function(evt) {
            document.getElementById('notification').innerHTML = `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                    Error loading data. Please try again.
                </div>
            `;
        });

        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.successful) {
                // Success handling
            }
        });

        function toggleDropdown(dropdownId) {
    // Close all other dropdowns first
    document.querySelectorAll('[id^="dropdown-"]').forEach(dropdown => {
        if (dropdown.id !== dropdownId) {
            dropdown.classList.add('hidden');
        }
    });
    
    // Toggle the clicked dropdown
    const dropdown = document.getElementById(dropdownId);
    dropdown.classList.toggle('hidden');
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('[onclick*="toggleDropdown"]') && !event.target.closest('[id^="dropdown-"]')) {
        document.querySelectorAll('[id^="dropdown-"]').forEach(dropdown => {
            dropdown.classList.add('hidden');
        });
    }
});

function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    if (!notification) {
        console.warn('Notification div not found');
        return;
    }
    
    const bgColor = {
        'success': 'bg-green-100 border-green-400 text-green-700',
        'error': 'bg-red-100 border-red-400 text-red-700',
        'info': 'bg-blue-100 border-blue-400 text-blue-700',
        'warning': 'bg-yellow-100 border-yellow-400 text-yellow-700'
    }[type] || 'bg-blue-100 border-blue-400 text-blue-700';
    
    notification.innerHTML = `
        <div class="${bgColor} px-4 py-3 rounded border mb-4 shadow-lg">
            <div class="flex items-center justify-between">
                <span>${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-lg font-bold">√ó</button>
            </div>
        </div>
    `;
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.firstElementChild) {
            notification.firstElementChild.remove();
        }
    }, 5000);
}

// Action handlers
function editRule(ruleId) {
    console.log('Edit rule:', ruleId);
    
    // Close any open dropdowns first
    document.querySelectorAll('[id^="dropdown-"]').forEach(dropdown => {
        dropdown.classList.add('hidden');
    });
    
    const modal = document.getElementById('rule-modal');
    const modalContent = document.getElementById('modal-content');
    
    // CRITICAL: Always clear previous content first
    if (modalContent) {
        console.log('üßπ Clearing previous modal content');
        modalContent.innerHTML = `
            <div class="p-8 text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Loading rule editor...</p>
            </div>
        `;
    }
    
    if (modal) {
        modal.classList.add('show');
        // Prevent background scroll
        document.body.classList.add('modal-open');
        document.body.style.overflow = 'hidden';
    }
    
    // Clear any existing modal state
    if (window.modalState) {
        console.log('üßπ Clearing previous modal state');
        window.modalState = {};
    }
    
    // ENHANCED: Load the edit modal with aggressive cache busting
    const timestamp = Date.now();
    const url = `https://bef4xsajbb.execute-api.us-east-1.amazonaws.com/dev/rules?edit=${ruleId}&t=${timestamp}&nocache=${Math.random()}`;
    
    console.log('üîÑ Loading fresh modal content from:', url);
    
    htmx.ajax('GET', url, {
        target: '#modal-content',
        swap: 'innerHTML'
    }).then(() => {
        console.log('‚úÖ Edit modal loaded successfully');
    }).catch(error => {
        console.error('‚ùå Failed to load edit modal:', error);
        showNotification('Failed to load edit form. Please try again.', 'error');
        closeModal();
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('rule-modal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    }
});

function toggleDropdown(dropdownId) {
    // Close all other dropdowns first
    document.querySelectorAll('[id^="dropdown-"]').forEach(dropdown => {
        if (dropdown.id !== dropdownId) {
            dropdown.classList.add('hidden');
        }
    });
    
    // Toggle the clicked dropdown
    const dropdown = document.getElementById(dropdownId);
    if (dropdown) {
        dropdown.classList.toggle('hidden');
    }
}


// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('[onclick*="toggleDropdown"]') && !event.target.closest('[id^="dropdown-"]')) {
        document.querySelectorAll('[id^="dropdown-"]').forEach(dropdown => {
            dropdown.classList.add('hidden');
        });
    }
});


function cloneRule(ruleId) {
    console.log('Clone rule:', ruleId);
    showNotification('Clone functionality coming soon!', 'info');
}

function modelRule(ruleId) {
    console.log('Create model from rule:', ruleId);
    showNotification('Model creation functionality coming soon!', 'info');
}

function deleteRule(ruleId) {
    if (confirm('Are you sure you want to delete this rule?')) {
        console.log('Delete rule:', ruleId);
        showNotification('Delete functionality coming soon!', 'warning');
    }
}

document.body.addEventListener('htmx:responseError', function(evt) {
    console.error('HTMX Response Error:', evt.detail);
    showNotification('Error loading data. Please try again.', 'error');
});

document.body.addEventListener('htmx:sendError', function(evt) {
    console.error('HTMX Send Error:', evt.detail);
    showNotification('Network error. Please check your connection.', 'error');
});

document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.successful) {
        console.log('HTMX request successful');
    } else {
        console.error('HTMX request failed:', evt.detail);
    }
});

    </script>
</body>
</html>