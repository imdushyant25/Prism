<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claims Enrichment Rules Management</title>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .modal { display: none; }
        .modal.show { display: flex; }
        .filter-badge {
            animation: slideIn 0.2s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .collapse {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .expand {
            max-height: 500px;
            transition: max-height 0.3s ease-in;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-6">
        <!-- Simplified Header - NO PBM selector, NO New Rule button -->
        <div class="bg-white rounded-lg border p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Claims Enrichment Rules</h1>
                    <p class="text-gray-600 mt-2">Manage your claim enrichment business rules across PBMs</p>
                </div>
            </div>
        </div>

        <!-- Filters Container - Load dynamically -->
        <div id="filters-container" 
             hx-get="https://bef4xsajbb.execute-api.us-east-1.amazonaws.com/dev/rules?component=filters" 
             hx-trigger="load">
            <!-- Filters will load here -->
            <div class="bg-white rounded-lg border p-4">
                <div class="text-center text-gray-500">Loading filters...</div>
            </div>
        </div>

        <!-- Rules Container -->
        <div id="rules-container">
            <div class="bg-white rounded-lg border p-8">
                <div class="text-center text-gray-500">
                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Select Filters to View Rules</h3>
                    <p class="text-gray-500">Use the filters above to load and manage enrichment rules</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for New/Edit Rule -->
    <div id="rule-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div id="modal-content">
                <!-- Modal content will load here via HTMX -->
            </div>
        </div>
    </div>

    <!-- Notification Area -->
    <div id="notification" class="fixed top-4 right-4 z-50">
        <!-- Success/error messages will appear here -->
    </div>

    <script>
        // Close modal
        function closeModal() {
            document.getElementById('rule-modal').classList.remove('show');
        }

        // Close modal when clicking outside
        document.getElementById('rule-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // HTMX event handlers
        document.body.addEventListener('htmx:responseError', function(evt) {
            document.getElementById('notification').innerHTML = `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                    Error loading data. Please try again.
                </div>
            `;
        });

        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.successful) {
                // Success handling
            }
        });

        function toggleDropdown(dropdownId) {
    // Close all other dropdowns first
    document.querySelectorAll('[id^="dropdown-"]').forEach(dropdown => {
        if (dropdown.id !== dropdownId) {
            dropdown.classList.add('hidden');
        }
    });
    
    // Toggle the clicked dropdown
    const dropdown = document.getElementById(dropdownId);
    dropdown.classList.toggle('hidden');
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('[onclick*="toggleDropdown"]') && !event.target.closest('[id^="dropdown-"]')) {
        document.querySelectorAll('[id^="dropdown-"]').forEach(dropdown => {
            dropdown.classList.add('hidden');
        });
    }
});

// Action handlers (stubs for now)
function editRule(ruleId) {
    console.log('Edit rule:', ruleId);
    // TODO: Open edit modal
}

function cloneRule(ruleId) {
    console.log('Clone rule:', ruleId);
    // TODO: Open clone modal
}

function modelRule(ruleId) {
    console.log('Create model from rule:', ruleId);
    // TODO: Create modeling version
}

function deleteRule(ruleId) {
    if (confirm('Are you sure you want to delete this rule?')) {
        console.log('Delete rule:', ruleId);
        // TODO: Delete via API
    }
}
    </script>
</body>
</html>